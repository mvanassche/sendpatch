<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta name="generator" content="HTML Tidy for Cygwin (vers 1st September 2004), see www.w3.org" />
<title>Submit patches</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Org-mode" />
<meta name="author" content="Fabrice Niessen" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" type="text/css" href="http://svn/mc/xxx/org-style/trunk/styles/bigblow/css/htmlize.css" />
<link rel="stylesheet" type="text/css" href="http://svn/mc/xxx/org-style/trunk/styles/bigblow/css/bigblow.css" />
<link rel="stylesheet" type="text/css" href="http://svn/mc/xxx/org-style/trunk/styles/bigblow/css/hideshow.css" />
<script type="text/javascript" src="http://svn/mc/xxx/org-style/trunk/styles/bigblow/js/jquery-1.11.0.min.js">
</script>
<script type="text/javascript" src="http://svn/mc/xxx/org-style/trunk/styles/bigblow/js/jquery-ui-1.10.2.min.js">
</script>
<script type="text/javascript" src="http://svn/mc/xxx/org-style/trunk/styles/bigblow/js/jquery.localscroll-min.js">
</script>
<script type="text/javascript" src="http://svn/mc/xxx/org-style/trunk/styles/bigblow/js/jquery.scrollTo-1.4.3.1-min.js">
</script>
<script type="text/javascript" src="http://svn/mc/xxx/org-style/trunk/styles/bigblow/js/jquery.zclip.min.js">
</script>
<script type="text/javascript" src="http://svn/mc/xxx/org-style/trunk/styles/bigblow/js/bigblow.js">
</script>
<script type="text/javascript" src="http://svn/mc/xxx/org-style/trunk/styles/bigblow/js/hideshow.js">
</script>
</head>
<body>
<div id="content">
<h1 class="title">Submit patches</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Commit guidelines</a>
<ul>
<li><a href="#sec-1-1">1.1. Changes</a></li>
<li><a href="#sec-1-2">1.2. Commit messages</a></li>
<li><a href="#sec-1-3">1.3. Release notes</a></li>
<li><a href="#sec-1-4">1.4. Example</a>
<ul>
<li><a href="#sec-1-4-1">1.4.1. Commit message</a></li>
<li><a href="#sec-1-4-2">1.4.2. ChangeLog</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-2">2. Code</a>
<ul>
<li><a href="#sec-2-1">2.1. Send patch</a>
<ul>
<li><a href="#sec-2-1-1">2.1.1. Version number</a></li>
<li><a href="#sec-2-1-2">2.1.2. Usage</a></li>
<li><a href="#sec-2-1-3">2.1.3. Configuration</a></li>
<li><a href="#sec-2-1-4">2.1.4. Helper functions</a></li>
<li><a href="#sec-2-1-5">2.1.5. Init</a></li>
<li><a href="#sec-2-1-6">2.1.6. Check current directory</a></li>
<li><a href="#sec-2-1-7">2.1.7. Get URL of project</a></li>
<li><a href="#sec-2-1-8">2.1.8. Override settings</a></li>
<li><a href="#sec-2-1-9">2.1.9. Display changed files</a></li>
<li><a href="#sec-2-1-10">2.1.10. Display ignored files</a></li>
<li><a href="#sec-2-1-11">2.1.11. Ask for short log message</a></li>
<li><a href="#sec-2-1-12">2.1.12. Generate name for patch files</a></li>
<li><a href="#sec-2-1-13">2.1.13. Make patch file</a></li>
<li><a href="#sec-2-1-14">2.1.14. Edit log message</a></li>
<li><a href="#sec-2-1-15">2.1.15. Convert email contents into UTF-8</a></li>
<li><a href="#sec-2-1-16">2.1.16. Deduce log message for commit</a></li>
<li><a href="#sec-2-1-17">2.1.17. Deduce subject line for email</a></li>
<li><a href="#sec-2-1-18">2.1.18. Auto-commit changes</a></li>
<li><a href="#sec-2-1-19">2.1.19. Auto-send email</a></li>
<li><a href="#sec-2-1-20">2.1.20. Auto-delete temporary files</a></li>
</ul>
</li>
<li><a href="#sec-2-2">2.2. Display list of files</a></li>
<li><a href="#sec-2-3">2.3. Display changes</a></li>
<li><a href="#sec-2-4">2.4. Ignore files from the command line</a></li>
<li><a href="#sec-2-5">2.5. Unaccent</a></li>
<li><a href="#sec-2-6">2.6. Install environment</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Commit guidelines</h2>
<div class="outline-text-2" id="text-1">
<p>This list hopes to help all of us to improve our commits.</p>
</div>
<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Changes</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>Make commits of logical units.</li>
<li>Check for unnecessary whitespace before committing.</li>
<li>Do not check in commented out code or unneeded files.</li>
<li>Make sure that you have tests for the bug you are fixing.</li>
<li>Make sure that the test suite passes after your commit.</li>
<li>Do not attach your patch, but submit it "inline" in the mail body, <i>unless you cannot teach your mailer to leave the formatting of the patch alone</i>.</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Commit messages</h3>
<div class="outline-text-3" id="text-1-2">
<p><a href="http://chris.beams.io/posts/git-commit/">How to Write a Git Commit Message</a></p>
<ul class="org-ul">
<li>The first line of the commit message ("<b>subject line</b>") should be a <b>short description</b> (50 characters is the <i>soft</i> limit). It should be <b>capitalized</b> and it should <b>not end with a period</b>.</li>
<li>The body should provide a meaningful commit message, which:
<ul class="org-ul">
<li>uses the active voice in the <b>imperative present tense</b>: "fix bug", not "fixed bug" or "fixes bug" - we prefer to describe "what the patch does" rather than "what the patch did".</li>
<li>includes motivation for the change ("why"), and contrasts its implementation with previous behavior.</li>
</ul>
</li>
</ul>
<p>Keep in mind that commit messages are often read <b>without</b> seeing the diffs, and without the possibility to see which other files you committed just before that particular commit!</p>
<p>If the ChangeLog is a one-liner, you can use it as the commit summary.</p>
<p>Note for Emacs - It is suggested to write the ChangeLog first and then use <code>C-c C-a</code> from the <code>*VC-Log*</code> buffer.</p>
</div>
</div>
<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> Release notes</h3>
<div class="outline-text-3" id="text-1-3">
<p>We have introduced the possibility to insert release notes in log messages. In order to make them stand out, all such notes must be enclosed in a <code>#+begin_releasenotes</code> .. <code>#end_releasenotes</code> block.</p>
</div>
</div>
<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> Example</h3>
<div class="outline-text-3" id="text-1-4"></div>
<div id="outline-container-sec-1-4-1" class="outline-4">
<h4 id="sec-1-4-1"><span class="section-number-4">1.4.1</span> Commit message</h4>
<div class="outline-text-4" id="text-1-4-1">
<p>By settling on an "official commit log format":</p>
<div class="org-src-container">
<pre class="src src-text">
TITLE

PARAGRAPH-1

PARAGRAPH-2

* FILE (FUNC): DESCRIPTION-OF-CHANGE.
</pre></div>
<p>Example:</p>
<div class="org-src-container">
<pre class="src src-text">
Summarize changes in around 50 characters or less

More detailed explanatory text, if necessary, to present a bird-eye view that is
hard to grasp by looking at the diffs.  Wrap it to about 72 characters or so.
In some contexts, the first line is treated as the subject of an email and the
rest of the text as the body.  The blank line separating the summary from the
body is critical; some tools can get confused if you run the two together.

Explain the problem that this commit is solving. Focus on why you
are making this change as opposed to how (the code explains that).
Are there side effects or other unintuitive consequenses of this
change? Here's the place to explain them.

Further paragraphs come after blank lines.

- Bullet points are okay, too

- Typically a hyphen is used for the bullet, with blank lines in between, but
  conventions vary here

- Use a hanging indent

If you use an issue tracker, put references to them at the bottom, like this:

Resolves: #123
See also: #456, #789
</pre></div>
</div>
</div>
<div id="outline-container-sec-1-4-2" class="outline-4">
<h4 id="sec-1-4-2"><span class="section-number-4">1.4.2</span> ChangeLog</h4>
<div class="outline-text-4" id="text-1-4-2">
<p>ChangeLog files could be generated from the commit messages:</p>
<div class="org-src-container">
<pre class="src src-text">
YYYY-MM-DD  AUTHOR  &lt;EMAIL&gt;

TITLE
* FILE (FUNC): DESCRIPTION-OF-CHANGE.
</pre></div>
<p>(modulo some bol TABs).</p>
<p>Though, ChangeLog and commit logs may be orthogonal:</p>
<ul class="org-ul">
<li>A commit log describes <i>why</i> (and <i>how</i>) code was changed.</li>
<li>A ChangeLog helps you understand <i>where</i> and <i>what</i> code changed.</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Code</h2>
<div class="outline-text-2" id="text-2"></div>
<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Send patch</h3>
<div class="outline-text-3" id="text-2-1">
<p>This script sends patches:</p>
<ul class="org-ul">
<li>to the SVN repository (that is, <i>commits</i> them)</li>
<li>to mailing lists (that is, <i>emails</i> them)</li>
</ul>
</div>
<div id="outline-container-sec-2-1-1" class="outline-4">
<h4 id="sec-2-1-1"><span class="section-number-4">2.1.1</span> Version number</h4>
<div class="outline-text-4" id="text-2-1-1">
<div class="org-src-container">
<pre class="src src-emacs-lisp" id="current-time">
(format-time-string <span class="org-string">"%Y%m%d.%H%M"</span>)
</pre></div>
<div class="org-src-container">
<pre class="src src-sh">
    cat &lt;&lt; EOF
<span class="org-sh-heredoc">This is $(basename $0), version: 20150410.1021.</span>

<span class="org-sh-heredoc">EOF</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-2-1-2" class="outline-4">
<h4 id="sec-2-1-2"><span class="section-number-4">2.1.2</span> Usage</h4>
<div class="outline-text-4 org-src-container" id="text-2-1-2">
<pre class="src src-sh">
<span class="org-function-name">Usage</span> ()
{
    cat &lt;&lt; EOF 1&gt;&amp;2
<span class="org-sh-heredoc">Usage: $(basename $0) [OPTION]... [FILE]...</span>
<span class="org-sh-heredoc">Submit patches per email.</span>

<span class="org-sh-heredoc">  -h, --help     display this help and exit</span>

<span class="org-sh-heredoc">Report $(basename $0) bugs to fni@xxx.com</span>
<span class="org-sh-heredoc">Commit guidelines: <a href="http://svn/mc/xxx/sendpatch/trunk/send-patch.html">&lt;http://svn/mc/xxx/sendpatch/trunk/send-patch.html&gt;</a></span>
<span class="org-sh-heredoc">EOF</span>
    <span class="org-keyword">exit</span> 2
}

<span class="org-keyword">while </span><span class="org-builtin">true</span>; <span class="org-keyword">do</span>
    <span class="org-keyword">case</span> <span class="org-string">"$1"</span><span class="org-keyword"> in</span>
        -h | --help) Usage ;;
        * ) <span class="org-keyword">break</span> ;;
    <span class="org-keyword">esac</span>
<span class="org-keyword">done</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">now do something with $@</span>
</pre></div>
</div>
<div id="outline-container-sec-2-1-3" class="outline-4">
<h4 id="sec-2-1-3"><span class="section-number-4">2.1.3</span> Configuration</h4>
<div class="outline-text-4" id="text-2-1-3"></div>
<ol class="org-ol">
<li><a id="sec-2-1-3-1" name="sec-2-1-3-1"></a>Per project options<br />
<div class="outline-text-5 org-src-container" id="text-2-1-3-1">
<pre class="src src-sh">
<span class="org-variable-name">mailto</span>=<span class="org-string">"mc-reviews@xxx.com"</span>
<span class="org-variable-name">prefix</span>=<span class="org-string">"[PATCH]"</span>
<span class="org-variable-name">excludefileregexp</span>=<span class="org-string">""</span>
</pre></div>
</li>
<li><a id="sec-2-1-3-2" name="sec-2-1-3-2"></a>Per user options<br />
<div class="outline-text-5 org-src-container" id="text-2-1-3-2">
<pre class="src src-sh">
<span class="org-variable-name">patchfileprefix</span>=<span class="org-string">""</span>
<span class="org-variable-name">commitmsgfileprefix</span>=<span class="org-string">""</span>
<span class="org-variable-name">emailfileprefix</span>=<span class="org-string">""</span>
<span class="org-variable-name">asksubject</span>=<span class="org-string">"yes"</span>
<span class="org-variable-name">autocommit</span>=<span class="org-string">"ask"</span>
<span class="org-variable-name">autosendemail</span>=<span class="org-string">"ask"</span>
<span class="org-variable-name">autodeletetmpfiles</span>=<span class="org-string">"ask"</span>
<span class="org-variable-name">emailcommand</span>=<span class="org-string">'blat "$email" -to "$mailto" -subject "$prefix $subject" -server "mail" -f "John Doe <a href="mailto:johndoe%40example.com">&lt;johndoe@example.com&gt;</a>" -charset UTF-8'</span>
</pre></div>
</li>
<li><a id="sec-2-1-3-3" name="sec-2-1-3-3"></a>Example<br />
<div class="outline-text-5" id="text-2-1-3-3">
<p>A commonly configured option could be:</p>
<div class="org-src-container">
<pre class="src src-sh">
<span class="org-variable-name">excludefileregexp</span>=<span class="org-string">"(\\\.html|\\\.xml)"</span>
</pre></div>
<p>Note the use of <b>3 backslashes</b>!</p>
</div>
</li>
<li><a id="sec-2-1-3-4" name="sec-2-1-3-4"></a>Files<br />
<div class="outline-text-5" id="text-2-1-3-4">
<p>All the <i>default</i> settings can be overridden in:</p>
<ol class="org-ol">
<li><code>~/.sendpatchrc</code></li>
<li><code>sendpatch.common</code> in the root directory of a working copy</li>
<li><code>sendpatch.params</code> in the root directory of a working copy</li>
</ol>
<p>in that order.</p>
<p>Remember that those configuration files must be encoded with <b>Unix line endings</b>!</p>
</div>
</li>
</ol>
</div>
<div id="outline-container-sec-2-1-4" class="outline-4">
<h4 id="sec-2-1-4"><span class="section-number-4">2.1.4</span> Helper functions</h4>
<div class="outline-text-4" id="text-2-1-4">
<p>The exit status follows the conventions for programs such as <code>grep</code>, <code>cmp</code>, and <code>diff</code>:</p>
<div class="org-src-container">
<pre class="src src-sh">
<span class="org-function-name">die</span> () {
    printf <span class="org-string">"$(basename $0): $@\n"</span> &gt; /dev/stderr
    <span class="org-keyword">exit</span> 2                              <span class="org-comment-delimiter"># </span><span class="org-comment">an error occurred</span>
}
</pre></div>
<div class="org-src-container">
<pre class="src src-sh">
<span class="org-function-name">cecho</span> () {
    <span class="org-variable-name">black</span>=<span class="org-string">"\e[30m"</span>
    <span class="org-variable-name">red</span>=<span class="org-string">"\e[31m"</span>
    <span class="org-variable-name">green</span>=<span class="org-string">"\e[32m"</span>
    <span class="org-variable-name">yellow</span>=<span class="org-string">"\e[33m"</span>
    <span class="org-variable-name">blue</span>=<span class="org-string">"\e[34m"</span>
    <span class="org-variable-name">magenta</span>=<span class="org-string">"\e[35m"</span>
    <span class="org-variable-name">cyan</span>=<span class="org-string">"\e[36m"</span>
    <span class="org-variable-name">white</span>=<span class="org-string">"\e[37m"</span>

    <span class="org-variable-name">BLACK</span>=<span class="org-string">"\e[1;30m"</span>
    <span class="org-variable-name">RED</span>=<span class="org-string">"\e[1;31m"</span>
    <span class="org-variable-name">GREEN</span>=<span class="org-string">"\e[1;32m"</span>
    <span class="org-variable-name">YELLOW</span>=<span class="org-string">"\e[1;33m"</span>
    <span class="org-variable-name">BLUE</span>=<span class="org-string">"\e[1;34m"</span>
    <span class="org-variable-name">MAGENTA</span>=<span class="org-string">"\e[1;35m"</span>
    <span class="org-variable-name">CYAN</span>=<span class="org-string">"\e[1;36m"</span>
    <span class="org-variable-name">WHITE</span>=<span class="org-string">"\e[1;37m"</span>

    <span class="org-variable-name">reset</span>=<span class="org-string">"\e[0m"</span>

    <span class="org-variable-name">color</span>=${<span class="org-variable-name">YELLOW</span>}
    printf <span class="org-string">"$color$1$reset\n"</span>
}
</pre></div>
</div>
<ol class="org-ol">
<li><a id="sec-2-1-4-1" name="sec-2-1-4-1"></a>VCS in use<br />
<div class="outline-text-5 org-src-container" id="text-2-1-4-1">
<pre class="src src-sh">
<span class="org-function-name">vcs_info</span> () {
    <span class="org-builtin">local</span> <span class="org-variable-name">default</span>=<span class="org-string">"tfs"</span>

    <span class="org-comment-delimiter"># </span><span class="org-comment">recursively search for `.svn' directory</span>
    <span class="org-keyword">while</span> [[ <span class="org-negation-char">!</span> ( -d .svn ) &amp;&amp; ( <span class="org-string">"$(pwd)"</span> != <span class="org-string">"/"</span> ) ]]; <span class="org-keyword">do</span>
        <span class="org-builtin">cd</span> ..
    <span class="org-keyword">done</span>

    <span class="org-keyword">if</span> [[ -d .svn ]]; <span class="org-keyword">then</span>
        printf <span class="org-string">"svn\n"</span>
    <span class="org-keyword">else</span> <span class="org-comment-delimiter"># </span><span class="org-comment">not found</span>
        printf <span class="org-string">"$default\n"</span>
    <span class="org-keyword">fi</span>
}
</pre></div>
</li>
<li><a id="sec-2-1-4-2" name="sec-2-1-4-2"></a>TFS<br />
<div class="outline-text-5 org-src-container" id="text-2-1-4-2">
<pre class="src src-sh">
<span class="org-function-name">fixtfsbinaryfiles</span> () {
    sed -r <span class="org-string">"s/^(.*): files differ$/Index: \1\n===================================================================\nCannot display: file marked as a binary type.\n===================================================================/"</span>
}
</pre></div>
</li>
<li><a id="sec-2-1-4-3" name="sec-2-1-4-3"></a>Yes/No prompt function<br />
<div class="outline-text-5" id="text-2-1-4-3">
<div class="org-src-container">
<pre class="src src-sh">
<span class="org-function-name">ask</span> () {
    <span class="org-keyword">while </span><span class="org-builtin">true</span>; <span class="org-keyword">do</span>
        <span class="org-keyword">if</span> [ <span class="org-string">"${2:-}"</span> = <span class="org-string">"Y"</span> ]; <span class="org-keyword">then</span>
            <span class="org-variable-name">prompt</span>=<span class="org-string">"Y/n"</span>
            <span class="org-variable-name">default</span>=Y
        <span class="org-keyword">elif</span> [ <span class="org-string">"${2:-}"</span> = <span class="org-string">"N"</span> ]; <span class="org-keyword">then</span>
            <span class="org-variable-name">prompt</span>=<span class="org-string">"y/N"</span>
            <span class="org-variable-name">default</span>=N
        <span class="org-keyword">else</span>
            <span class="org-variable-name">prompt</span>=<span class="org-string">"y/n"</span>
            <span class="org-variable-name">default</span>=
        <span class="org-keyword">fi</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">ask the question (without the need to press RET)</span>
        printf <span class="org-string">"$1 ($prompt): "</span>
        <span class="org-builtin">read</span> -n 1 -r REPLY
        printf <span class="org-string">"\n"</span> <span class="org-comment-delimiter"># </span><span class="org-comment">just a final linefeed</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">default?</span>
        <span class="org-keyword">if</span> [ -z <span class="org-string">"$REPLY"</span> ]; <span class="org-keyword">then</span>
            <span class="org-variable-name">REPLY</span>=$<span class="org-variable-name">default</span>
        <span class="org-keyword">fi</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">check if the reply is valid</span>
        <span class="org-keyword">case</span> <span class="org-string">"$REPLY"</span><span class="org-keyword"> in</span>
            y*|Y*) <span class="org-keyword">return</span> 0 ;;
            n*|N*) <span class="org-keyword">return</span> 1 ;;
        <span class="org-keyword">esac</span>
    <span class="org-keyword">done</span>
}
</pre></div>
<p>See <a href="https://gist.github.com/1965569">usage samples</a> for defaults (when the user presses <code>RET</code> without giving an answer).</p>
<p>See <a href="http://stackoverflow.com/questions/1885525/how-do-i-prompt-a-user-for-confirmation-in-bash-script">How do I prompt a user for confirmation in bash script?</a> for the regexp match operator "=~".</p>
</div>
</li>
</ol>
</div>
<div id="outline-container-sec-2-1-5" class="outline-4">
<h4 id="sec-2-1-5"><span class="section-number-4">2.1.5</span> Init</h4>
<div class="outline-text-4 org-src-container" id="text-2-1-5">
<pre class="src src-sh">
<span class="org-variable-name">tmpfile</span>=<span class="org-string">"/tmp/$(basename $0).$$"</span>
<span class="org-keyword">trap</span> <span class="org-string">"rm -f $tmpfile"</span> EXIT SIGHUP SIGINT SIGQUIT SIGTERM

<span class="org-variable-name">userconfig</span>=~/.sendpatchrc
<span class="org-variable-name">projectconfig</span>=sendpatch.common
<span class="org-variable-name">userprojectconfig</span>=sendpatch.params

<span class="org-builtin">export</span> <span class="org-variable-name">vcs</span>=$(vcs_info)
printf <span class="org-string">"VC backend: $vcs\n"</span>

<span class="org-keyword">case</span> $<span class="org-variable-name">vcs</span><span class="org-keyword"> in</span>
    svn)
        <span class="org-variable-name">VCS_STATUS</span>=<span class="org-string">"svn status --ignore-externals"</span>
        ;;
    tfs)
        <span class="org-variable-name">VCS_STATUS</span>=<span class="org-string">"tf status"</span>
        ;;
    *)
        die <span class="org-string">"VCS backend is not supported"</span>
        ;;
<span class="org-keyword">esac</span>
</pre></div>
</div>
<div id="outline-container-sec-2-1-6" class="outline-4">
<h4 id="sec-2-1-6"><span class="section-number-4">2.1.6</span> Check current directory</h4>
<div class="outline-text-4" id="text-2-1-6">
<p>Note that, for TFS, we impose to find a <code>sendpatch.common</code> file in order to conclude that we're at the root directory of a working copy, or not.</p>
<div class="org-src-container">
<pre class="src src-sh">
<span class="org-keyword">case</span> $<span class="org-variable-name">vcs</span><span class="org-keyword"> in</span>
    svn)
        [[ -d .svn ]] <span class="org-sh-escaped-newline">\</span>
            || die <span class="org-string">"\`$(pwd)' is not the root directory of a working copy"</span>
        ;;
    tfs)
        [[ -f $<span class="org-variable-name">projectconfig</span> ]] <span class="org-sh-escaped-newline">\</span>
            || die <span class="org-string">"\`$(pwd)' is not the root directory of a working copy"</span>
        ;;
<span class="org-keyword">esac</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-2-1-7" class="outline-4">
<h4 id="sec-2-1-7"><span class="section-number-4">2.1.7</span> Get URL of project</h4>
<div class="outline-text-4 org-src-container" id="text-2-1-7">
<pre class="src src-sh">
<span class="org-keyword">case</span> $<span class="org-variable-name">vcs</span><span class="org-keyword"> in</span>
    svn)
        <span class="org-variable-name">url</span>=$(svn info | grep -E <span class="org-string">"^URL"</span>)/
        ;;
    tfs)
        <span class="org-comment-delimiter"># </span><span class="org-comment">get collection and project</span>
        tf workfold &gt; $<span class="org-variable-name">tmpfile</span>
        <span class="org-variable-name">url</span>=$(cat $<span class="org-variable-name">tmpfile</span> | grep -E <span class="org-string">"^(Collection| \\$/)"</span> | sed <span class="org-string">"/^ \\$/{s/:.*//}"</span>)
        ;;
<span class="org-keyword">esac</span>
</pre></div>
</div>
<div id="outline-container-sec-2-1-8" class="outline-4">
<h4 id="sec-2-1-8"><span class="section-number-4">2.1.8</span> Override settings</h4>
<div class="outline-text-4" id="text-2-1-8">
<div class="org-src-container">
<pre class="src src-sh">
[[ -f $<span class="org-variable-name">userconfig</span> ]] &amp;&amp; . $<span class="org-variable-name">userconfig</span>
[[ -f $<span class="org-variable-name">projectconfig</span> ]] &amp;&amp; . $<span class="org-variable-name">projectconfig</span>
[[ -f $<span class="org-variable-name">userprojectconfig</span> ]] &amp;&amp; . $<span class="org-variable-name">userprojectconfig</span>
</pre></div>
<p>Default sender of the email is John Doe. If not configured otherwise, bail out:</p>
<div class="org-src-container">
<pre class="src src-sh">
printf <span class="org-string">"$emailcommand"</span> | grep <span class="org-string">"John Doe"</span> <span class="org-sh-escaped-newline">\</span>
    &amp;&amp; die <span class="org-string">"Please fix the sender address in the email command"</span>
</pre></div>
<p>Default editor is <code>$EDITOR</code>. If not found, set Emacs:</p>
<div class="org-src-container">
<pre class="src src-sh">
: ${<span class="org-variable-name">EDITOR</span>:=<span class="org-string">"emacsclient"</span>}
<span class="org-builtin">which</span> <span class="org-string">"$EDITOR"</span> &gt; /dev/null 2&gt;&amp;1 || die <span class="org-string">"editor not found"</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-2-1-9" class="outline-4">
<h4 id="sec-2-1-9"><span class="section-number-4">2.1.9</span> Display changed files</h4>
<div class="outline-text-4" id="text-2-1-9">
<p>Shows what files have been modified in your working copy, what files have been changed in the repository since your last update, and which files, if any, conflict with your modifications. The <code>-u</code> option is what forces the command to access the repository for this check.</p>
<div class="org-src-container">
<pre class="src src-sh">
cecho <span class="org-string">"\nChanged files (to be committed now):"</span>
<span class="org-keyword">case</span> $<span class="org-variable-name">vcs</span><span class="org-keyword"> in</span>
    svn)
        ${<span class="org-variable-name">VCS_STATUS</span>} -u $<span class="org-variable-name">@</span> | grep -E -v <span class="org-string">"^\? "</span> | tee $<span class="org-variable-name">tmpfile</span>
        cat $<span class="org-variable-name">tmpfile</span> | cut -c 1-9 | grep -E <span class="org-string">"^M       \*"</span> <span class="org-sh-escaped-newline">\</span>
            &amp;&amp; die <span class="org-string">"a newer revision exists on the server"</span>
        cat $<span class="org-variable-name">tmpfile</span> | cut -c 1-9 | grep -E <span class="org-string">"^C"</span> &amp;&amp; die <span class="org-string">"conflicted item modification"</span>
        ;;
    tfs)
        <span class="org-builtin">export</span> <span class="org-variable-name">rootdirwin</span>=$(cygpath -w -l <span class="org-string">"$(pwd)"</span>)
        <span class="org-comment-delimiter"># </span><span class="org-comment">printf "Root directory (in Windows format) : $rootdirwin\n"</span>
        ${<span class="org-variable-name">VCS_STATUS</span>} $<span class="org-variable-name">@</span> &gt; $<span class="org-variable-name">tmpfile</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">No idea why, but we can't directly pipe the output of `tf status'</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">command</span>
        cat $<span class="org-variable-name">tmpfile</span> | grep -F -i <span class="org-string">"$rootdirwin"</span> | tee $<span class="org-variable-name">tmpfile</span>.out
        mv $<span class="org-variable-name">tmpfile</span>.out $<span class="org-variable-name">tmpfile</span>
        ;;
<span class="org-keyword">esac</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-2-1-10" class="outline-4">
<h4 id="sec-2-1-10"><span class="section-number-4">2.1.10</span> Display ignored files</h4>
<div class="outline-text-4" id="text-2-1-10">
<div class="org-src-container">
<pre class="src src-sh">
<span class="org-keyword">case</span> $<span class="org-variable-name">vcs</span><span class="org-keyword"> in</span>
    svn)
        cecho <span class="org-string">"\nUntracked files:"</span>
        ${<span class="org-variable-name">VCS_STATUS</span>} $<span class="org-variable-name">@</span> | grep -E <span class="org-string">"^\? "</span> | grep -v <span class="org-string">" 0.*-"</span>
        ;;
    tfs)
        ;;
<span class="org-keyword">esac</span>
</pre></div>
<p>Stop if no changes are to be committed. Though, that may mean that you should <code>add</code> some of the files currently ignored; hence, it's good to make this check after having sent some information to the user…</p>
<div class="org-src-container">
<pre class="src src-sh">
[[ $(cat $<span class="org-variable-name">tmpfile</span> | wc -l) -gt 0 ]] <span class="org-sh-escaped-newline">\</span>
    || die <span class="org-string">"no changes to send to the repository"</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-2-1-11" class="outline-4">
<h4 id="sec-2-1-11"><span class="section-number-4">2.1.11</span> Ask for short log message</h4>
<div class="outline-text-4 org-src-container" id="text-2-1-11">
<pre class="src src-sh">
<span class="org-keyword">if</span> [[ <span class="org-string">"$asksubject"</span> != <span class="org-string">"no"</span> ]]; <span class="org-keyword">then</span>
    printf <span class="org-string">"\nSubject (short log): "</span>
    <span class="org-builtin">read</span> subject
<span class="org-keyword">fi</span>
</pre></div>
</div>
<div id="outline-container-sec-2-1-12" class="outline-4">
<h4 id="sec-2-1-12"><span class="section-number-4">2.1.12</span> Generate name for patch files</h4>
<div class="outline-text-4 org-src-container" id="text-2-1-12">
<pre class="src src-sh">
<span class="org-variable-name">oldcounter</span>=$(ls ${<span class="org-variable-name">patchfileprefix</span>}0???-*.patch 2&gt; /dev/null | sort --reverse <span class="org-sh-escaped-newline">\</span>
    | head -n 1 | sed <span class="org-string">"s/^${patchfileprefix}00*//"</span> | cut -d <span class="org-string">"-"</span> -f 1)
<span class="org-variable-name">newcounterpadded</span>=$(printf <span class="org-string">"%04d"</span> <span class="org-string">"$(( oldcounter + 1 ))"</span>)
<span class="org-variable-name">filename</span>=<span class="org-string">"$newcounterpadded-$(printf "$subject\n" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g')"</span>

<span class="org-variable-name">patch</span>=${<span class="org-variable-name">patchfileprefix</span>}${<span class="org-variable-name">filename</span>}.patch
<span class="org-variable-name">commitmsg</span>=${<span class="org-variable-name">commitmsgfileprefix</span>}${<span class="org-variable-name">filename</span>}.log
<span class="org-variable-name">email</span>=${<span class="org-variable-name">emailfileprefix</span>}${<span class="org-variable-name">filename</span>}.txt
</pre></div>
</div>
<div id="outline-container-sec-2-1-13" class="outline-4">
<h4 id="sec-2-1-13"><span class="section-number-4">2.1.13</span> Make patch file</h4>
<div class="outline-text-4" id="text-2-1-13">
<p>The patch file generated only reports <code>file.bin: files differ</code>. The fix for getting such names included in the log (list of modified files) is to replace that one-sentence with a traditional <code>Index:</code> marker.</p>
<div class="org-src-container">
<pre class="src src-sh">
makediff $<span class="org-variable-name">@</span> &gt; $<span class="org-variable-name">patch</span>.tmp
<span class="org-variable-name">retval</span>=$<span class="org-variable-name">?</span>

<span class="org-keyword">if</span> [ $<span class="org-variable-name">retval</span> -eq 0 ]; <span class="org-keyword">then</span>
    cat $<span class="org-variable-name">patch</span>.tmp | fixtfsbinaryfiles &gt; $<span class="org-variable-name">patch</span>
    rm $<span class="org-variable-name">patch</span>.tmp
<span class="org-keyword">else</span>
    rm $<span class="org-variable-name">patch</span>.tmp
    <span class="org-keyword">exit</span> 2
<span class="org-keyword">fi</span>
</pre></div>
<p><code>excludefileregexp</code> allows one to exclude useless or unreadable diffs from the email contents. That does not have any impact on the commit process itself…</p>
<div class="org-src-container">
<pre class="src src-sh">
<span class="org-keyword">if</span> [[ -n <span class="org-string">"$excludefileregexp"</span> ]]; <span class="org-keyword">then</span>
    cat $<span class="org-variable-name">patch</span> |<span class="org-sh-escaped-newline">\</span>
    awk -v <span class="org-variable-name">pattern</span>=<span class="org-string">"^Index: .*$excludefileregexp"</span> <span class="org-sh-escaped-newline">\</span>
        <span class="org-string">'BEGIN {deleteline = 0;}</span>
<span class="org-string">         $0 ~ pattern {deleteline = 1; next;}</span>
<span class="org-string">         // &amp;&amp; deleteline == 0 {print $0;}</span>
<span class="org-string">         /^Index: / &amp;&amp; deleteline == 1 {print $0; deleteline = 0;}'</span> <span class="org-sh-escaped-newline">\</span>
    &gt; $<span class="org-variable-name">patch</span>.excluded 2&gt; /dev/null
<span class="org-keyword">else</span>
    cp $<span class="org-variable-name">patch</span> $<span class="org-variable-name">patch</span>.excluded
<span class="org-keyword">fi</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-2-1-14" class="outline-4">
<h4 id="sec-2-1-14"><span class="section-number-4">2.1.14</span> Edit log message</h4>
<div class="outline-text-4 org-src-container" id="text-2-1-14">
<pre class="src src-sh">
<span class="org-comment-delimiter"># </span><span class="org-comment">ask for commit message</span>
cat &lt;&lt;EOF &gt; $<span class="org-variable-name">email</span>
<span class="org-sh-heredoc"># Hey, Emacs! This is a -*- Diff -*- file</span>
<span class="org-sh-heredoc"># Please enter the commit message for your changes.  Lines starting with '#'</span>
<span class="org-sh-heredoc"># will be ignored...</span>
<span class="org-sh-heredoc"># The FIRST LINE of the commit message should be a short description and should</span>
<span class="org-sh-heredoc"># skip the full stop.  It will become the subject of the email.</span>
<span class="org-sh-heredoc">EOF</span>
<span class="org-keyword">case</span> $<span class="org-variable-name">vcs</span><span class="org-keyword"> in</span>
    svn)
        <span class="org-variable-name">makelogparams</span>=<span class="org-string">"$*"</span>
        ;;
    tfs)
        <span class="org-variable-name">makelogparams</span>=<span class="org-string">"-f $patch"</span>
        ;;
<span class="org-keyword">esac</span>
{ printf <span class="org-string">"$subject\n"</span>; makelog $<span class="org-variable-name">makelogparams</span> | sort | uniq; printf <span class="org-string">"\n---\n"</span>; printf <span class="org-string">"$url\n\n"</span>; <span class="org-sh-escaped-newline">\</span>
  cat $<span class="org-variable-name">patch</span>.excluded; } &gt;&gt; $<span class="org-variable-name">email</span>
mv $<span class="org-variable-name">patch</span>.excluded $<span class="org-variable-name">patch</span>
printf <span class="org-string">"\nEdit commit log message and email to send to '$mailto'...\n"</span>
<span class="org-string">"$EDITOR"</span> $<span class="org-variable-name">email</span>
test $<span class="org-variable-name">?</span> -eq 0 || die <span class="org-string">"edit failed"</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">remove comments from editable part</span>
sed <span class="org-string">'0,/^---$/{/^#[^+].*$/d;}'</span> &lt; $<span class="org-variable-name">email</span> &gt; $<span class="org-variable-name">email</span>.nocomment; mv $<span class="org-variable-name">email</span>.nocomment $<span class="org-variable-name">email</span>
</pre></div>
</div>
<div id="outline-container-sec-2-1-15" class="outline-4">
<h4 id="sec-2-1-15"><span class="section-number-4">2.1.15</span> Convert email contents into UTF-8</h4>
<div class="outline-text-4 org-src-container" id="text-2-1-15">
<pre class="src src-sh">
<span class="org-comment-delimiter"># </span><span class="org-comment">convert email into UTF-8</span>
<span class="org-keyword">case</span> <span class="org-string">"$(file --brief $email 2&gt; /dev/null | sed 's/unified diff output, //')"</span><span class="org-keyword"> in</span>
    UTF-8*)
        ;;
    ASCII*)
        ;;
    ISO-8859*)
        printf <span class="org-string">"Character encoding of diff output: ISO-8859... Converting it to UTF-8...\n"</span>
        cat $<span class="org-variable-name">email</span> | iconv -c -f ISO-8859-1 -t UTF-8 &gt; $<span class="org-variable-name">tmpfile</span>
        mv $<span class="org-variable-name">tmpfile</span> $<span class="org-variable-name">email</span>
        ;;
    *)
        printf <span class="org-string">"Potential problems found in email file $email: $(file --brief $email)\n"</span>
        ask <span class="org-string">"Continue?"</span> || die <span class="org-string">"exiting..."</span>
        ;;
<span class="org-keyword">esac</span>
printf <span class="org-string">"Email:         $email\n"</span>
</pre></div>
</div>
<div id="outline-container-sec-2-1-16" class="outline-4">
<h4 id="sec-2-1-16"><span class="section-number-4">2.1.16</span> Deduce log message for commit</h4>
<div class="outline-text-4 org-src-container" id="text-2-1-16">
<pre class="src src-sh">
sed <span class="org-string">'/^---$/,$d'</span> &lt; $<span class="org-variable-name">email</span> &gt; $<span class="org-variable-name">commitmsg</span>
</pre></div>
</div>
<div id="outline-container-sec-2-1-17" class="outline-4">
<h4 id="sec-2-1-17"><span class="section-number-4">2.1.17</span> Deduce subject line for email</h4>
<div class="outline-text-4 org-src-container" id="text-2-1-17">
<pre class="src src-sh">
<span class="org-comment-delimiter"># </span><span class="org-comment">get new subject for email (first line of log message)</span>
head -n 1 $<span class="org-variable-name">email</span> &gt; $<span class="org-variable-name">tmpfile</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">replace accented letters by their unaccented equivalent</span>
<span class="org-keyword">case</span> <span class="org-string">"$(file --brief $tmpfile 2&gt; /dev/null)"</span><span class="org-keyword"> in</span>
    UTF-8*)
        <span class="org-variable-name">subject</span>=<span class="org-string">"$(cat $tmpfile | iconv -c -f UTF-8 -t ISO-8859-1 | unaccent)"</span>
        ;;
    ISO-8859*|ASCII*)
        <span class="org-variable-name">subject</span>=<span class="org-string">"$(cat $tmpfile | unaccent)"</span>
        ;;
    *)
        die <span class="org-string">"unknown character encoding: $(file --brief $tmpfile).  Did you put the subject as first line?"</span>
        ;;
<span class="org-keyword">esac</span>
</pre></div>
</div>
<div id="outline-container-sec-2-1-18" class="outline-4">
<h4 id="sec-2-1-18"><span class="section-number-4">2.1.18</span> Auto-commit changes</h4>
<div class="outline-text-4 org-src-container" id="text-2-1-18">
<pre class="src src-sh">
printf <span class="org-string">"\n"</span>
<span class="org-keyword">if</span> [[ <span class="org-string">"$autocommit"</span> = <span class="org-string">"ask"</span> ]]; <span class="org-keyword">then</span>
    ask <span class="org-string">"Commit?"</span> &amp;&amp; <span class="org-variable-name">askcommit</span>=<span class="org-string">"yes"</span> || <span class="org-variable-name">askcommit</span>=<span class="org-string">"no"</span>
<span class="org-keyword">fi</span>

<span class="org-keyword">if</span> [[ <span class="org-string">"$autocommit"</span> = <span class="org-string">"yes"</span> || <span class="org-string">"$askcommit"</span> = <span class="org-string">"yes"</span> ]]; <span class="org-keyword">then</span>
    printf <span class="org-string">"Committing...\n"</span>
    <span class="org-keyword">case</span> $<span class="org-variable-name">vcs</span><span class="org-keyword"> in</span>
        svn)
            svn commit --file $<span class="org-variable-name">commitmsg</span> $<span class="org-variable-name">@</span>
            ;;
        tfs)
            tf checkin /comment:@$<span class="org-variable-name">commitmsg</span> /noprompt $<span class="org-variable-name">@</span>
            ;;
    <span class="org-keyword">esac</span>
    <span class="org-variable-name">rc</span>=$<span class="org-variable-name">?</span>
<span class="org-keyword">else</span>
    printf <span class="org-string">"Nothing gets committed...\n"</span>
    <span class="org-variable-name">rc</span>=0
<span class="org-keyword">fi</span>
test $<span class="org-variable-name">rc</span> -eq 0 || die <span class="org-string">"commit failed"</span>
</pre></div>
</div>
<div id="outline-container-sec-2-1-19" class="outline-4">
<h4 id="sec-2-1-19"><span class="section-number-4">2.1.19</span> Auto-send email</h4>
<div class="outline-text-4 org-src-container" id="text-2-1-19">
<pre class="src src-sh">
printf <span class="org-string">"\n"</span>
<span class="org-keyword">if</span> [[ <span class="org-string">"$autosendemail"</span> = <span class="org-string">"ask"</span> ]]; <span class="org-keyword">then</span>
    printf <span class="org-string">"Environment for sending email:\n"</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">print the email command</span>
    printf <span class="org-string">"$emailcommand\n"</span>
    [[ -f $<span class="org-variable-name">userconfig</span> ]] &amp;&amp; grep <span class="org-string">"excludefileregexp"</span> $<span class="org-variable-name">userconfig</span>
    [[ -f $<span class="org-variable-name">projectconfig</span> ]] &amp;&amp; grep <span class="org-string">"excludefileregexp"</span> $<span class="org-variable-name">projectconfig</span>
    [[ -f $<span class="org-variable-name">userprojectconfig</span> ]] &amp;&amp; grep <span class="org-string">"excludefileregexp"</span> $<span class="org-variable-name">userprojectconfig</span>
    ask <span class="org-string">"Send email?"</span> &amp;&amp; <span class="org-variable-name">asksendemail</span>=<span class="org-string">"yes"</span> || <span class="org-variable-name">asksendemail</span>=<span class="org-string">"no"</span>
<span class="org-keyword">fi</span>

<span class="org-keyword">if</span> [[ <span class="org-string">"$autosendemail"</span> = <span class="org-string">"yes"</span> || <span class="org-string">"$asksendemail"</span> = <span class="org-string">"yes"</span> ]]; <span class="org-keyword">then</span>
    printf <span class="org-string">"Sending email...\n"</span>
    <span class="org-builtin">eval</span> <span class="org-string">"$emailcommand"</span>
    <span class="org-variable-name">rc</span>=$<span class="org-variable-name">?</span>
<span class="org-keyword">else</span>
    printf <span class="org-string">"Nothing gets sent...\n"</span>
    <span class="org-variable-name">rc</span>=0
<span class="org-keyword">fi</span>
test $<span class="org-variable-name">rc</span> -eq 0 || die <span class="org-string">"send email failed"</span>
</pre></div>
</div>
<div id="outline-container-sec-2-1-20" class="outline-4">
<h4 id="sec-2-1-20"><span class="section-number-4">2.1.20</span> Auto-delete temporary files</h4>
<div class="outline-text-4 org-src-container" id="text-2-1-20">
<pre class="src src-sh">
printf <span class="org-string">"\n"</span>
<span class="org-keyword">if</span> [[ <span class="org-string">"$autodeletetmpfiles"</span> = <span class="org-string">"ask"</span> ]]; <span class="org-keyword">then</span>
    ask <span class="org-string">"Delete temp files?"</span> &amp;&amp; <span class="org-variable-name">askdeletetmpfiles</span>=<span class="org-string">"yes"</span> || <span class="org-variable-name">askdeletetmpfiles</span>=<span class="org-string">"no"</span>
<span class="org-keyword">fi</span>

<span class="org-keyword">if</span> [[ <span class="org-string">"$autodeletetmpfiles"</span> = <span class="org-string">"yes"</span> || <span class="org-string">"$askdeletetmpfiles"</span> = <span class="org-string">"yes"</span> ]]; <span class="org-keyword">then</span>
    printf <span class="org-string">"Deleting temp files...\n"</span>
    rm $<span class="org-variable-name">patch</span> $<span class="org-variable-name">commitmsg</span> $<span class="org-variable-name">email</span>
    <span class="org-variable-name">rc</span>=$<span class="org-variable-name">?</span>
<span class="org-keyword">else</span>
    printf <span class="org-string">"Nothing gets deleted...\n"</span>
    <span class="org-variable-name">rc</span>=0
<span class="org-keyword">fi</span>
test $<span class="org-variable-name">rc</span> -eq 0 || die <span class="org-string">"delete temp files failed"</span>

<span class="org-comment-delimiter">## </span><span class="org-comment">sendpatch ends here</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> Display list of files</h3>
<div class="outline-text-3" id="text-2-2">
<p>Display a list of files to be committed, for the commit log message.</p>
<div class="org-src-container">
<pre class="src src-sh">
<span class="org-comment-delimiter"># </span><span class="org-comment">Usage: makelog [-f diff-file] [svn diff options]</span>
<span class="org-comment-delimiter">#</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Make a log message for a change, including the header, and the relative</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">pathnames of the changed files.  Output goes to stdout.</span>
<span class="org-comment-delimiter">#</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">If a you have a pre-existing diff file, use `-f diff-file' to use this file.</span>

printf <span class="org-string">"\n"</span>

{ <span class="org-keyword">if</span> [ <span class="org-string">"$1"</span> = <span class="org-string">"-f"</span> ]
<span class="org-keyword">then</span>
    cat $<span class="org-variable-name">2</span>
<span class="org-keyword">else</span>
    svn diff -x -w --no-diff-deleted --show-copies-as-adds $<span class="org-variable-name">*</span> 2&gt;&amp;1
<span class="org-keyword">fi</span>; } | sed <span class="org-string">'/^Index:/!d'</span> | sed <span class="org-string">'s/^Index: /\t* /'</span> | sed <span class="org-string">'s/$/:/'</span>
</pre></div>
<p>With the option <code>--show-copies-as-adds</code>, copied (and moved) files are listed.</p>
<p>Using <code>sed '/^Index:/!d'</code> (instead of <code>egrep "^Index:"</code>) allows to filter the lines we're interested in, even if the file contains binary characters (such as non-breakable spaces). On the other hand, <code>grep</code> would simply declare that "Binary file matches".</p>
</div>
</div>
<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> Display changes</h3>
<div class="outline-text-3" id="text-2-3">
<p>Display the changes made to all target files, and display deleted and new files as well.</p>
<p>With the option <code>-x -w</code>, <code>svn diff</code> <b>shows only non-whitespace line changes</b> between two revisions.</p>
<p>With the option <code>--no-diff-deleted</code>, differences for deleted files are not printed.</p>
<div class="org-src-container">
<pre class="src src-sh">
<span class="org-comment-delimiter"># </span><span class="org-comment">Usage: makediff [svn diff options]</span>
<span class="org-comment-delimiter">#</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Make a diff file, ready for review.  It contains the diffs of all files,</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">followed by the text of new files.  Output goes to stdout.</span>

<span class="org-variable-name">tmpfile</span>=<span class="org-string">"/tmp/$(basename $0).$$"</span>
<span class="org-keyword">trap</span> <span class="org-string">"rm -f $tmpfile"</span> EXIT SIGHUP SIGINT SIGQUIT SIGTERM

<span class="org-keyword">case</span> $<span class="org-variable-name">vcs</span><span class="org-keyword"> in</span>
    svn)
        svn diff -x -w --no-diff-deleted $<span class="org-variable-name">*</span> &gt; $<span class="org-variable-name">tmpfile</span>
        <span class="org-variable-name">retval</span>=$<span class="org-variable-name">?</span>
        ;;
    tfs)
        tf diff $<span class="org-variable-name">*</span> /format:Unified &gt; $<span class="org-variable-name">tmpfile</span>
        <span class="org-variable-name">retval</span>=$<span class="org-variable-name">?</span>
        cat $<span class="org-variable-name">tmpfile</span> <span class="org-sh-escaped-newline">\</span>
            | grep -E -i -v <span class="org-string">"^(edit|modifier|add|ajouter|renommer): "</span> <span class="org-sh-escaped-newline">\</span>
            | sed -r <span class="org-string">"s/^(File:|Fichier\o240:)/Index:/"</span> &gt; $<span class="org-variable-name">tmpfile</span>.out
        mv $<span class="org-variable-name">tmpfile</span>.out $<span class="org-variable-name">tmpfile</span>
        ;;
<span class="org-keyword">esac</span>

<span class="org-keyword">if</span> [ $<span class="org-variable-name">retval</span> -eq 0 ]; <span class="org-keyword">then</span>
    cat $<span class="org-variable-name">tmpfile</span>
<span class="org-keyword">else</span>
    <span class="org-keyword">exit</span> 2
<span class="org-keyword">fi</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4"><span class="section-number-3">2.4</span> Ignore files from the command line</h3>
<div class="outline-text-3" id="text-2-4">
<p>Add a file (or a file glob pattern) to ignore without deleting the previous value of the <code>svn:ignore</code> property… from the command line.</p>
<div class="org-src-container">
<pre class="src src-sh">
<span class="org-comment-delimiter"># </span><span class="org-comment">Usage: svnignore admin/notes/\*.tex</span>

<span class="org-variable-name">target</span>=<span class="org-string">"$1"</span>
<span class="org-variable-name">targetdirectory</span>=$(dirname $<span class="org-variable-name">target</span>)
<span class="org-variable-name">targetfilepattern</span>=$(basename $<span class="org-variable-name">target</span>)

<span class="org-variable-name">svnignores</span>=$(svn propget svn:ignore <span class="org-string">"$targetdirectory"</span>)
<span class="org-variable-name">svnignores</span>=<span class="org-string">"$svnignores"</span>$<span class="org-string">'\n'"$targetfilepattern"</span>
printf <span class="org-string">"Ignore '$targetfilepattern'\n"</span>
svn propset svn:ignore <span class="org-string">"$svnignores"</span> <span class="org-string">"$targetdirectory"</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5"><span class="section-number-3">2.5</span> Unaccent</h3>
<div class="outline-text-3" id="text-2-5">
<p>Remove accents, replacing accented letters by their unaccented equivalent.</p>
<div class="org-src-container">
<pre class="src src-sh">
s/\o240/ /g
s/\o300/A/g
s/\o301/A/g
s/\o302/A/g
s/\o304/A/g
s/\o310/E/g
s/\o311/E/g
s/\o312/E/g
s/\o313/E/g
s/\o315/I/g
s/\o316/I/g
s/\o323/O/g
s/\o324/O/g
s/\o325/O/g
s/\o326/O/g
s/\o331/U/g
s/\o332/U/g
s/\o333/U/g
s/\o334/U/g
s/\o340/a/g
s/\o341/a/g
s/\o342/a/g
s/\o344/a/g
s/\o347/c/g
s/\o350/e/g
s/\o351/e/g
s/\o352/e/g
s/\o353/e/g
s/\o355/i/g
s/\o356/i/g
s/\o357/i/g
s/\o363/o/g
s/\o364/o/g
s/\o365/o/g
s/\o366/o/g
s/\o371/u/g
s/\o372/u/g
s/\o373/u/g
s/\o374/u/g
</pre></div>
</div>
</div>
<div id="outline-container-sec-2-6" class="outline-3">
<h3 id="sec-2-6"><span class="section-number-3">2.6</span> Install environment</h3>
<div class="outline-text-3" id="text-2-6">
<p>Symlink the files.</p>
<div class="org-src-container">
<pre class="src src-sh">
ln -f -s $(<span class="org-builtin">pwd</span>)/sendpatch ~/bin/sendpatch
ln -f -s $(<span class="org-builtin">pwd</span>)/makelog   ~/bin/makelog
ln -f -s $(<span class="org-builtin">pwd</span>)/makediff  ~/bin/makediff
ln -f -s $(<span class="org-builtin">pwd</span>)/svnignore ~/bin/svnignore
ln -f -s $(<span class="org-builtin">pwd</span>)/unaccent  ~/bin/unaccent
</pre></div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Fabrice Niessen</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
